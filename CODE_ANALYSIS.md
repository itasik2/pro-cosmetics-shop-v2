# Анализ кодовой базы pro-cosmetics-shop-v2

Дата: 2026-02-05

## Что проверено
- Структура проекта Next.js (App Router), API-роуты, Prisma-схема, auth-слой.
- Базовая техническая проверка: TypeScript (`npx tsc --noEmit`) и production build (`npm run build`).

## Сильные стороны
1. **Хорошая серверная валидация на критичных путях checkout/products** через `zod`.
2. **Корректная транзакционность создания заказа** с повторной проверкой остатков в БД.
3. **Централизованная Prisma-инициализация** с переиспользованием клиента в dev.

## Ключевые риски (по приоритету)

### 1) Критично: отсутствие авторизации на части админских API
Сейчас есть несколько API, которые изменяют данные без проверки сессии администратора:
- `POST /api/posts`
- `PUT /api/posts/[id]`
- `DELETE /api/posts/[id]`
- `PUT /api/site-settings`
- `POST /api/upload/product-image`

Риск: любой внешний клиент может модифицировать контент, тему сайта или загружать файлы при доступе к endpoint.

**Рекомендация:**
- Добавить единый guard (`isAdmin`) и применять его ко всем mutating-роутам админ-функций.
- Вынести проверку в `lib/adminGuard.ts`, чтобы исключить дублирование.

### 2) Высокий: в build-пайплайне нет fail-safe без `DATABASE_URL`
Сборка падает на `prisma migrate deploy`, если отсутствует `DATABASE_URL`.

Риск: нестабильность CI/CD и локальных проверок без полностью настроенного окружения.

**Рекомендация:**
- Явно документировать required env для build.
- Для preview/CI окружений использовать отдельную стратегию миграций (или проверку переменных до запуска).

### 3) Средний: смешанный уровень строгости в API
Часть API (например products/brands) использует `zod` + обработку ошибок, часть (posts) — минимальные ручные проверки.

Риск: неравномерное качество валидации и диагностики ошибок.

**Рекомендация:**
- Унифицировать DTO-валидацию через `zod` во всех CRUD-роутах.

### 4) Средний: нет rate-limit/abuse-control на публичных endpoint
Публичные маршруты (`/api/ask`, возможно `/api/checkout`) не ограничены по частоте.

Риск: abuse, рост затрат (особенно при LLM-интеграции), деградация сервиса.

**Рекомендация:**
- Добавить rate limit (по IP/session) на write-heavy и cost-heavy роуты.

## Технические результаты проверки
- `npx tsc --noEmit` — успешно.
- `npm run build` — неуспешно в текущем окружении: отсутствует `DATABASE_URL`.

## Быстрый план улучшений (1-2 спринта)
1. **Безопасность API (P0):** закрыть незащищённые mutating routes, добавить единый admin-guard.
2. **Надёжность CI (P1):** привести `.env.example` и документацию к реальным build-требованиям.
3. **Качество API (P1):** унифицировать валидацию и ответы ошибок.
4. **Ограничение нагрузки (P1/P2):** rate-limit + базовое логирование аномалий.

## Итог
Кодовая база уже рабочая и содержит сильные элементы (валидация checkout, транзакции, Prisma-паттерн), но требует приоритетного усиления безопасности на нескольких API-эндпоинтах, чтобы исключить несанкционированные изменения данных.
